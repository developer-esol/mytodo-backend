openapi: 3.0.0
info:
  title: Chat Firebase Routes
  version: 1.0.0
  description: Endpoints for fetching and sending chat messages (personal & group) backed by Firebase and MongoDB.
servers:
  - url: /api/chats
    description: Chat routes base path

tags:
  - name: Chat
    description: Personal and group chat operations

paths:
  /chats/{taskId}/messages:
    get:
      tags:
        - Chat
      summary: Get chronological messages for a task (legacy personal chat)
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
          description: MongoDB Task _id
      responses:
        "200":
          description: Array of messages in chronological order
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Message"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      tags:
        - Chat
      summary: Send a message to a personal chat (legacy)
      security:
        - bearerAuth: [] # ← Already correct (lowercase 'b')
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendMessageRequest"
      responses:
        "200":
          description: Message saved to Firebase and notification attempted
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  success:
                    type: boolean
                  message:
                    type: string
                  chatId:
                    type: string
                  recipientId:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /group-chats/{taskId}/messages:
    get:
      tags:
        - Chat
      summary: Get group chat messages (chronological)
      security:
        - bearerAuth: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
          description: Number of messages to return (most recent)
      responses:
        "200":
          description: Group chat messages and metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  groupChatId:
                    type: string
                  firebaseChatId:
                    type: string
                  messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/Message"
                  participantCount:
                    type: integer
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

    post:
      tags:
        - Chat
      summary: Send a message to a group chat
      security:
        - bearerAuth: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendGroupMessageRequest"
      responses:
        "200":
          description: Group message saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  messageId:
                    type: string
                  groupChatId:
                    type: string
                  firebaseChatId:
                    type: string
                  message:
                    type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /group-chats/{taskId}/system-message:
    post:
      tags:
        - Chat
      summary: Send a system message to a group chat (offers, assignments, backend triggers)
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SystemMessageRequest"
      responses:
        "200":
          description: System message saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  messageId:
                    type: string
                  message:
                    type: string
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /group-chats/{taskId}/participants:
    get:
      tags:
        - Chat
      summary: Get active participants for a group chat
      security:
        - bearerAuth: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: List of active participants
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  participants:
                    type: array
                    items:
                      $ref: "#/components/schemas/Participant"
                  participantCount:
                    type: integer
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

components:
  securitySchemes:
    bearerAuth: # ← CHANGED from BearerAuth to match global definition
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    Message:
      type: object
      properties:
        id:
          type: string
        text:
          type: string
        senderId:
          type: string
        senderName:
          type: string
        senderAvatar:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time
        messageType:
          type: string
          example: text
        metadata:
          type: object
          description: Arbitrary metadata (channel-specific)
          additionalProperties: true

    SendMessageRequest:
      type: object
      required:
        - text
        - senderId
        - senderName
      properties:
        text:
          type: string
        senderId:
          type: string
        senderName:
          type: string

    SendGroupMessageRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
        messageType:
          type: string
          example: text
        metadata:
          type: object
          additionalProperties: true

    SystemMessageRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
        messageType:
          type: string
          example: system
        triggerUserId:
          type: string
          description: optional user id that triggered the system message
        metadata:
          type: object
          additionalProperties: true

    Participant:
      type: object
      properties:
        userId:
          type: string
        role:
          type: string
        user:
          type: object
          properties:
            id:
              type: string
            firstName:
              type: string
            lastName:
              type: string
            avatar:
              type: string
            rating:
              type: number
        joinedAt:
          type: string
          format: date-time
        isActive:
          type: boolean

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
